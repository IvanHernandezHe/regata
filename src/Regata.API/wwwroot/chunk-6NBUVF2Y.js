import{a as Q}from"./chunk-VNGMKSSX.js";import{c as K}from"./chunk-BVIVYH6A.js";import"./chunk-C5GIYBMA.js";import{a as L,b as j,c as O,d as U,e as R,f as X,g as G,i as H,n as z,p as J}from"./chunk-VNE54M5M.js";import{a as S}from"./chunk-CLVRU5UC.js";import{g as W,h as q,j as B,k as F,r as I}from"./chunk-N2J27IAP.js";import{Ab as w,Cb as V,Da as d,Db as D,Eb as _,Fb as x,Gb as y,Ma as P,Mb as v,Ob as C,Qb as N,R as A,Ra as g,W as f,aa as u,ba as m,cb as p,db as r,eb as a,kb as k,nb as b,ob as c,vb as T,yb as s,zb as h}from"./chunk-KUB3M4GV.js";var E=class n{#e=f(I);#t=S.apiBaseUrl+"/addresses";list(){return this.#e.get(this.#t,{withCredentials:!0})}create(i){return this.#e.post(this.#t,i,{withCredentials:!0})}update(i,e){return this.#e.put(`${this.#t}/${i}`,e,{withCredentials:!0})}setDefault(i){return this.#e.post(`${this.#t}/${i}/default`,{},{withCredentials:!0})}remove(i){return this.#e.delete(`${this.#t}/${i}`,{withCredentials:!0})}static \u0275fac=function(e){return new(e||n)};static \u0275prov=A({token:n,factory:n.\u0275fac,providedIn:"root"})};var M=class n{#e=f(I);#t=S.apiBaseUrl+"/config";get(){return this.#e.get(this.#t,{withCredentials:!0})}static \u0275fac=function(e){return new(e||n)};static \u0275prov=A({token:n,factory:n.\u0275fac,providedIn:"root"})};function $(n,i){if(n&1&&(r(0,"span"),s(1),a()),n&2){let e=c().$implicit;d(),w(", ",e.line2)}}function ee(n,i){n&1&&(r(0,"span",22),s(1,"Predeterminada"),a())}function te(n,i){if(n&1){let e=k();r(0,"div",16)(1,"label",17)(2,"input",18),y("ngModelChange",function(o){u(e);let l=c(2);return x(l.selectedAddressId,o)||(l.selectedAddressId=o),m(o)}),a(),r(3,"div",19)(4,"div"),s(5),g(6,$,2,1,"span",10),a(),r(7,"small",20),s(8),a(),r(9,"div"),g(10,ee,2,0,"span",21),a()()()()}if(n&2){let e=i.$implicit,t=c(2);d(2),p("value",e.id),_("ngModel",t.selectedAddressId),d(3),h(e.line1),d(),p("ngIf",e.line2),d(2),D("",e.city,", ",e.state," ",e.postalCode," \xB7 ",e.country),d(2),p("ngIf",e.isDefault)}}function ie(n,i){if(n&1&&(r(0,"div")(1,"div",14),g(2,te,11,9,"div",15),a()()),n&2){let e=c();d(2),p("ngForOf",e.addresses)}}function ne(n,i){if(n&1){let e=k();r(0,"form",23),b("submit",function(o){u(e);let l=c();return m(l.addAddress(o))}),r(1,"div",16)(2,"input",24),y("ngModelChange",function(o){u(e);let l=c();return x(l.newAddr.line1,o)||(l.newAddr.line1=o),m(o)}),a()(),r(3,"div",16)(4,"input",25),y("ngModelChange",function(o){u(e);let l=c();return x(l.newAddr.line2,o)||(l.newAddr.line2=o),m(o)}),a()(),r(5,"div",26)(6,"input",27),y("ngModelChange",function(o){u(e);let l=c();return x(l.newAddr.city,o)||(l.newAddr.city=o),m(o)}),a()(),r(7,"div",26)(8,"input",28),y("ngModelChange",function(o){u(e);let l=c();return x(l.newAddr.state,o)||(l.newAddr.state=o),m(o)}),a()(),r(9,"div",26)(10,"input",29),y("ngModelChange",function(o){u(e);let l=c();return x(l.newAddr.postalCode,o)||(l.newAddr.postalCode=o),m(o)}),a()(),r(11,"div",30)(12,"label",31)(13,"input",32),y("ngModelChange",function(o){u(e);let l=c();return x(l.newAddr.isDefault,o)||(l.newAddr.isDefault=o),m(o)}),a(),s(14," Predeterminada"),a()(),r(15,"div",30)(16,"button",33),s(17,"Guardar direcci\xF3n"),a()()()}if(n&2){let e=c();d(2),_("ngModel",e.newAddr.line1),d(2),_("ngModel",e.newAddr.line2),d(2),_("ngModel",e.newAddr.city),d(2),_("ngModel",e.newAddr.state),d(2),_("ngModel",e.newAddr.postalCode),d(3),_("ngModel",e.newAddr.isDefault)}}function re(n,i){if(n&1&&(r(0,"tr")(1,"td"),s(2),a(),r(3,"td"),s(4),a(),r(5,"td"),s(6),v(7,"currency"),a(),r(8,"td"),s(9),v(10,"currency"),a()()),n&2){let e=i.$implicit;d(2),V("",e.brand," ",e.modelName," ",e.size),d(2),h(e.quantity),d(2),h(C(7,6,e.unitPrice,"MXN")),d(3),h(C(10,9,e.lineTotal,"MXN"))}}function ae(n,i){if(n&1&&(r(0,"div",40),s(1),v(2,"currency"),a()),n&2){let e=c(2);d(),w("Descuento: \u2212",C(2,1,e.summary.discount,"MXN"))}}function oe(n,i){if(n&1&&(r(0,"div")(1,"div",34)(2,"table",35)(3,"thead")(4,"tr")(5,"th"),s(6,"Producto"),a(),r(7,"th"),s(8,"Cantidad"),a(),r(9,"th"),s(10,"Precio"),a(),r(11,"th"),s(12,"Importe"),a()()(),r(13,"tbody"),g(14,re,11,12,"tr",36),a()()(),r(15,"div",37)(16,"div"),s(17),v(18,"currency"),a(),g(19,ae,3,4,"div",38),r(20,"div"),s(21),v(22,"currency"),a(),r(23,"div",39),s(24),v(25,"currency"),a()()()),n&2){let e=c();d(14),p("ngForOf",e.summary.items),d(3),w("Subtotal: ",C(18,5,e.summary.subtotal,"MXN")),d(2),p("ngIf",e.summary.discount>0),d(2),w("Env\xEDo: ",C(22,8,e.summary.shipping,"MXN")),d(3),w("Total: ",C(25,11,e.summary.total,"MXN"))}}function de(n,i){if(n&1&&(r(0,"span"),s(1),v(2,"date"),a()),n&2){let e=c(2);d(),w(" \xB7 expira: ",C(2,1,e.reservationExpires,"short"))}}function se(n,i){if(n&1&&(r(0,"div",41),s(1," Reserva activa: "),r(2,"code"),s(3),a(),g(4,de,3,4,"span",10),a()),n&2){let e=i.ngIf,t=c();d(3),h(e),d(),p("ngIf",t.reservationExpires)}}var Z=class n{cart=f(K);#e=f(Q);#t=f(E);#i=f(M);paying=!1;quoting=!1;payLabel="Pagar (sandbox)";summary=null;reservationToken=null;reservationExpires=null;addresses=[];selectedAddressId=null;showAdd=!1;newAddr={line1:"",line2:"",city:"",state:"",postalCode:"",isDefault:!0};pay(){let i=this.cart.items().map(t=>({productId:t.productId,quantity:t.qty}));if(!i.length)return;this.paying=!0;let e=this.cart.couponCode();this.#e.checkout({items:i,discountCode:e||void 0,reservationToken:this.reservationToken||void 0,addressId:this.selectedAddressId||void 0}).subscribe({next:t=>{window.location.href=t.checkoutUrl},error:()=>{this.paying=!1,alert("No se pudo iniciar el pago. Intenta de nuevo.")}})}quote(){let i=this.cart.items().map(t=>({productId:t.productId,quantity:t.qty}));if(!i.length)return;this.quoting=!0;let e=this.cart.couponCode();this.#e.quote({items:i,discountCode:e||void 0}).subscribe({next:t=>{this.summary={subtotal:t.subtotal,discount:t.discount,shipping:t.shipping,total:t.total,items:t.items},this.quoting=!1},error:()=>{this.quoting=!1,alert("No se pudo calcular el total")}})}reserve(){let i=this.cart.items().map(e=>({productId:e.productId,quantity:e.qty}));i.length&&this.#e.reserve({items:i,ttlSeconds:600}).subscribe({next:e=>{this.reservationToken=e.token,this.reservationExpires=e.expiresAtUtc,alert("Stock reservado por 10 minutos.")},error:e=>{alert(e?.error?.error||"No se pudo reservar")}})}ngOnDestroy(){this.reservationToken&&!this.paying&&this.#e.releaseReservation(this.reservationToken).subscribe({next:()=>{},error:()=>{}})}ngOnInit(){this.#t.list().subscribe({next:i=>{this.addresses=i,this.selectedAddressId=i.find(e=>e.isDefault)?.id||i[0]?.id||null},error:()=>{}}),this.#i.get().subscribe({next:i=>{this.payLabel=i.payments?.provider==="Stripe"?"Pagar":"Pagar (sandbox)"},error:()=>{}})}toggleAdd(){this.showAdd=!this.showAdd}addAddress(i){i.preventDefault(),!(!this.newAddr.line1||!this.newAddr.city||!this.newAddr.state||!this.newAddr.postalCode)&&this.#t.create({line1:this.newAddr.line1,line2:this.newAddr.line2,city:this.newAddr.city,state:this.newAddr.state,postalCode:this.newAddr.postalCode,isDefault:this.newAddr.isDefault}).subscribe({next:()=>{this.showAdd=!1,this.#t.list().subscribe({next:e=>{this.addresses=e,this.selectedAddressId=e.find(t=>t.isDefault)?.id||e[0]?.id||null}})},error:()=>{alert("No se pudo guardar")}})}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=P({type:n,selectors:[["ng-component"]],decls:22,vars:9,consts:[["addForm",""],[1,"container","my-4"],[1,"card","p-3","mb-3"],[1,"d-flex","justify-content-between","align-items-center","mb-2"],[1,"fw-semibold"],[1,"btn","btn-sm","btn-outline-secondary",3,"click"],[4,"ngIf","ngIfElse"],[1,"mb-3","d-flex","gap-2"],[1,"btn","btn-outline-dark",3,"click","disabled"],[1,"btn","btn-outline-secondary",3,"click","disabled"],[4,"ngIf"],[1,"mt-3"],["class","alert alert-secondary py-2",4,"ngIf"],[1,"btn","btn-success",3,"click","disabled"],[1,"row","g-2"],["class","col-12 col-md-6",4,"ngFor","ngForOf"],[1,"col-12","col-md-6"],[1,"d-flex","align-items-start","gap-2","border","rounded","p-2"],["type","radio","name","addr",3,"ngModelChange","value","ngModel"],[1,"flex-fill"],[1,"text-muted"],["class","badge text-bg-secondary",4,"ngIf"],[1,"badge","text-bg-secondary"],[1,"row","g-2",3,"submit"],["placeholder","Calle y n\xFAmero","name","line1","required","",1,"form-control",3,"ngModelChange","ngModel"],["placeholder","Interior, referencias (opcional)","name","line2",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-12","col-md-4"],["placeholder","Ciudad","name","city","required","",1,"form-control",3,"ngModelChange","ngModel"],["placeholder","Estado","name","state","required","",1,"form-control",3,"ngModelChange","ngModel"],["placeholder","C.P.","name","postal","required","",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-12"],[1,"form-check"],["type","checkbox","name","isDefault",1,"form-check-input",3,"ngModelChange","ngModel"],["type","submit",1,"btn","btn-dark"],[1,"table-responsive"],[1,"table","align-middle"],[4,"ngFor","ngForOf"],[1,"d-flex","justify-content-end","flex-column","align-items-end","gap-1"],["class","text-success",4,"ngIf"],[1,"h5"],[1,"text-success"],[1,"alert","alert-secondary","py-2"]],template:function(e,t){if(e&1){let o=k();r(0,"section",1)(1,"h2"),s(2,"Checkout"),a(),r(3,"div",2)(4,"div",3)(5,"div",4),s(6,"Direcci\xF3n de env\xEDo"),a(),r(7,"button",5),b("click",function(){return u(o),m(t.toggleAdd())}),s(8),a()(),g(9,ie,3,1,"div",6)(10,ne,18,6,"ng-template",null,0,N),a(),r(12,"div",7)(13,"button",8),b("click",function(){return u(o),m(t.quote())}),s(14,"Calcular total"),a(),r(15,"button",9),b("click",function(){return u(o),m(t.reserve())}),s(16,"Reservar 10 min"),a()(),g(17,oe,26,14,"div",10),r(18,"div",11),g(19,se,5,2,"div",12),r(20,"button",13),b("click",function(){return u(o),m(t.pay())}),s(21),a()()()}if(e&2){let o=T(11);d(8),h(t.showAdd?"Cancelar":"Agregar"),d(),p("ngIf",t.addresses.length&&!t.showAdd)("ngIfElse",o),d(4),p("disabled",t.quoting||t.cart.items().length===0),d(2),p("disabled",t.cart.items().length===0),d(2),p("ngIf",t.summary),d(2),p("ngIf",t.reservationToken),d(),p("disabled",t.cart.items().length===0||t.paying),d(),h(t.payLabel)}},dependencies:[q,W,J,G,j,L,H,O,U,z,X,R,F,B],encapsulation:2})};export{Z as CheckoutPage};
