import{a as S}from"./chunk-UFE4MYJG.js";import{c as I}from"./chunk-Z67MO5CF.js";import"./chunk-VERFBTRB.js";import{g as b,h as _,j as k,k as C}from"./chunk-DW6AFCKZ.js";import{$a as l,Aa as a,Gb as c,Ib as d,Ja as x,Oa as u,V as g,ab as i,bb as n,kb as f,lb as p,vb as r,wb as m,xb as v,zb as y}from"./chunk-BIY3REYI.js";function P(o,s){if(o&1&&(i(0,"tr")(1,"td"),r(2),n(),i(3,"td"),r(4),n(),i(5,"td"),r(6),c(7,"currency"),n(),i(8,"td"),r(9),c(10,"currency"),n()()),o&2){let e=s.$implicit;a(2),y("",e.brand," ",e.modelName," ",e.size),a(2),m(e.quantity),a(2),m(d(7,6,e.unitPrice,"MXN")),a(3),m(d(10,9,e.lineTotal,"MXN"))}}function T(o,s){if(o&1&&(i(0,"div",14),r(1),c(2,"currency"),n()),o&2){let e=p(2);a(),v("Descuento: \u2212",d(2,1,e.summary.discount,"MXN"))}}function q(o,s){if(o&1&&(i(0,"div")(1,"div",8)(2,"table",9)(3,"thead")(4,"tr")(5,"th"),r(6,"Producto"),n(),i(7,"th"),r(8,"Cantidad"),n(),i(9,"th"),r(10,"Precio"),n(),i(11,"th"),r(12,"Importe"),n()()(),i(13,"tbody"),u(14,P,11,12,"tr",10),n()()(),i(15,"div",11)(16,"div"),r(17),c(18,"currency"),n(),u(19,T,3,4,"div",12),i(20,"div",13),r(21),c(22,"currency"),n()()()),o&2){let e=p();a(14),l("ngForOf",e.summary.items),a(3),v("Subtotal: ",d(18,4,e.summary.subtotal,"MXN")),a(2),l("ngIf",e.summary.discount>0),a(2),v("Total: ",d(22,7,e.summary.total,"MXN"))}}function N(o,s){if(o&1&&(i(0,"span"),r(1),c(2,"date"),n()),o&2){let e=p(2);a(),v(" \xB7 expira: ",d(2,1,e.reservationExpires,"short"))}}function B(o,s){if(o&1&&(i(0,"div",15),r(1," Reserva activa: "),i(2,"code"),r(3),n(),u(4,N,3,4,"span",4),n()),o&2){let e=s.ngIf,t=p();a(3),m(e),a(),l("ngIf",t.reservationExpires)}}var E=class o{cart=g(I);#e=g(S);paying=!1;quoting=!1;summary=null;reservationToken=null;reservationExpires=null;pay(){let s=this.cart.items().map(t=>({productId:t.productId,quantity:t.qty}));if(!s.length)return;this.paying=!0;let e=this.cart.couponCode();this.#e.checkout({items:s,discountCode:e||void 0,reservationToken:this.reservationToken||void 0}).subscribe({next:t=>{window.location.href=t.checkoutUrl},error:()=>{this.paying=!1,alert("No se pudo iniciar el pago. Intenta de nuevo.")}})}quote(){let s=this.cart.items().map(t=>({productId:t.productId,quantity:t.qty}));if(!s.length)return;this.quoting=!0;let e=this.cart.couponCode();this.#e.quote({items:s,discountCode:e||void 0}).subscribe({next:t=>{this.summary={subtotal:t.subtotal,discount:t.discount,total:t.total,items:t.items},this.quoting=!1},error:()=>{this.quoting=!1,alert("No se pudo calcular el total")}})}reserve(){let s=this.cart.items().map(e=>({productId:e.productId,quantity:e.qty}));s.length&&this.#e.reserve({items:s,ttlSeconds:600}).subscribe({next:e=>{this.reservationToken=e.token,this.reservationExpires=e.expiresAtUtc,alert("Stock reservado por 10 minutos.")},error:e=>{alert(e?.error?.error||"No se pudo reservar")}})}ngOnDestroy(){this.reservationToken&&!this.paying&&this.#e.releaseReservation(this.reservationToken).subscribe({next:()=>{},error:()=>{}})}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=x({type:o,selectors:[["ng-component"]],decls:13,vars:5,consts:[[1,"container","my-4"],[1,"mb-3","d-flex","gap-2"],[1,"btn","btn-outline-dark",3,"click","disabled"],[1,"btn","btn-outline-secondary",3,"click","disabled"],[4,"ngIf"],[1,"mt-3"],["class","alert alert-secondary py-2",4,"ngIf"],[1,"btn","btn-success",3,"click","disabled"],[1,"table-responsive"],[1,"table","align-middle"],[4,"ngFor","ngForOf"],[1,"d-flex","justify-content-end","flex-column","align-items-end","gap-1"],["class","text-success",4,"ngIf"],[1,"h5"],[1,"text-success"],[1,"alert","alert-secondary","py-2"]],template:function(e,t){e&1&&(i(0,"section",0)(1,"h2"),r(2,"Checkout"),n(),i(3,"div",1)(4,"button",2),f("click",function(){return t.quote()}),r(5,"Calcular total"),n(),i(6,"button",3),f("click",function(){return t.reserve()}),r(7,"Reservar 10 min"),n()(),u(8,q,23,10,"div",4),i(9,"div",5),u(10,B,5,2,"div",6),i(11,"button",7),f("click",function(){return t.pay()}),r(12,"Pagar (sandbox)"),n()()()),e&2&&(a(4),l("disabled",t.quoting||t.cart.items().length===0),a(2),l("disabled",t.cart.items().length===0),a(2),l("ngIf",t.summary),a(2),l("ngIf",t.reservationToken),a(),l("disabled",t.cart.items().length===0||t.paying))},dependencies:[_,b,C,k],encapsulation:2})};export{E as CheckoutPage};
