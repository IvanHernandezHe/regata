import{a as C}from"./chunk-SG536L4V.js";import{a as f}from"./chunk-CLVRU5UC.js";import{q as k,r as l}from"./chunk-FI2SLH6F.js";import{R as c,Vb as p,W as a,Wb as I,a as u,b as d,la as h}from"./chunk-4XZ7JV2Z.js";var g=class o{#s=a(l);#r=f.apiBaseUrl+"/cart";get(){return this.#s.get(`${this.#r}`,{withCredentials:!0})}merge(t){return this.#s.post(`${this.#r}/merge`,{items:t},{withCredentials:!0})}add(t,e=1){return this.#s.post(`${this.#r}/items`,{productId:t,qty:e},{withCredentials:!0})}setQty(t,e){return this.#s.put(`${this.#r}/items/${t}`,{qty:e},{withCredentials:!0})}remove(t){return this.#s.delete(`${this.#r}/items/${t}`,{withCredentials:!0})}clear(){return this.#s.delete(`${this.#r}/clear`,{withCredentials:!0})}static \u0275fac=function(e){return new(e||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};var y=class o{#s=1;#r=h([]);toasts=this.#r.asReadonly();show(t,e="info",s=3e3,r,i){let n=this.#s++,m={id:n,text:t,type:e,durationMs:s,actionLabel:r,onAction:i};this.#r.update(q=>[...q,m]),setTimeout(()=>this.dismiss(n),s)}showWithAction(t,e,s,r="info",i=5e3){this.show(t,r,i,e,s)}success(t,e=2500){this.show(t,"success",e)}info(t,e=2500){this.show(t,"info",e)}warning(t,e=2500){this.show(t,"warning",e)}danger(t,e=2500){this.show(t,"danger",e)}dismiss(t){this.#r.update(e=>e.filter(s=>s.id!==t))}static \u0275fac=function(e){return new(e||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};var b=class o{#s=a(l);#r=f.apiBaseUrl+"/discounts";validate(t){let e=new k().set("code",t);return this.#s.get(`${this.#r}/validate`,{params:e,withCredentials:!0})}static \u0275fac=function(e){return new(e||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};var w=class o{#s="regata_cart_v1";#r="regata_cart_origin_v1";#u="regata_coupon_v1";#t=h(this.#y());items=this.#t.asReadonly();count=p(()=>this.#t().reduce((t,e)=>t+e.qty,0));subtotal=p(()=>this.#t().reduce((t,e)=>t+e.price*e.qty,0));#a=h(this.#v());coupon=this.#a.asReadonly();couponCode(){return this.#a()?.code??null}estimateDiscount=p(()=>{let t=this.#a();if(!t)return 0;let e=this.subtotal();return t.type===0?Math.round(e*t.value/100*100)/100:t.type===1?Math.min(e,t.value):0});#n=a(g);#o=a(C);#e=a(y);#g=a(b);constructor(){I(()=>{let t=JSON.stringify(this.#t());try{localStorage.setItem(this.#s,t)}catch{}}),I(()=>{let t=this.#a();try{t?localStorage.setItem(this.#u,JSON.stringify(t)):localStorage.removeItem(this.#u)}catch{}})}reload(){this.#o.isAuthenticated()&&this.#n.get().subscribe({next:t=>this.replaceFromServer(t.items.map(e=>({productId:e.productId,name:e.name,sku:e.sku,price:e.price,qty:e.qty,stock:e.stock}))),error:()=>{}})}add(t,e=1){this.#o.isAuthenticated()?this.#n.add(t.id,e).subscribe({next:s=>{this.replaceFromServer(s.items.map(r=>({productId:r.productId,name:r.name,sku:r.sku,price:r.price,qty:r.qty,stock:r.stock}))),this.#e.success("Producto agregado al carrito")},error:()=>{this.#m(t,e),this.#e.info("Agregado al carrito (offline)")}}):(this.#m(t,e),this.#e.success("Producto agregado al carrito"))}remove(t){let e=this.#t().find(s=>s.productId===t);this.#o.isAuthenticated()?this.#n.remove(t).subscribe({next:s=>{this.replaceFromServer(s.items.map(r=>({productId:r.productId,name:r.name,sku:r.sku,price:r.price,qty:r.qty,stock:r.stock}))),e&&this.#e.showWithAction("Producto quitado","Deshacer",()=>this.#h(e))},error:()=>{this.#p(t),e&&this.#e.showWithAction("Producto quitado","Deshacer",()=>this.#h(e))}}):(this.#p(t),e&&this.#e.showWithAction("Producto quitado","Deshacer",()=>this.#h(e)))}clear(){this.#o.isAuthenticated()?this.#n.clear().subscribe({next:t=>{this.replaceFromServer(t.items.map(e=>({productId:e.productId,name:e.name,sku:e.sku,price:e.price,qty:e.qty}))),this.#e.info("Carrito vaciado")},error:()=>{this.#t.set([]),this.#i("local"),this.#e.info("Carrito vaciado")}}):(this.#t.set([]),this.#i("local"),this.#e.info("Carrito vaciado"))}replaceFromServer(t){this.#t.set(t.map(e=>u({},e))),this.#i("server")}increment(t,e=1){if(e<=0)return;let s=this.#t().find(r=>r.productId===t);if(s&&Number.isFinite(s.stock)&&s.stock>0&&s.qty>=s.stock){this.#e.warning("Alcanzaste las existencias disponibles");return}if(this.#o.isAuthenticated()){let i=(this.#t().find(n=>n.productId===t)?.qty??0)+e;this.#c(t,i),this.#d(t,i)}else this.#b(t,e)}decrement(t,e=1){if(!(e<=0))if(this.#o.isAuthenticated()){let s=this.#t().find(i=>i.productId===t)?.qty??0,r=Math.max(0,s-e);this.#c(t,r),this.#d(t,r)}else this.#I(t,e)}setQty(t,e){if(!Number.isFinite(e)||e<1){this.remove(t);return}if(this.#o.isAuthenticated()){let s=Math.floor(e);this.#c(t,s),this.#d(t,s)}else this.#c(t,Math.floor(e))}isServerSynced(){try{return localStorage.getItem(this.#r)==="server"}catch{return!1}}markServerSynced(){this.#i("server")}markLocalChanged(){this.#i("local")}restoreSnapshot(t){if(this.#o.isAuthenticated()){let e=t.map(s=>({productId:s.productId,qty:s.qty}));this.#n.merge(e).subscribe({next:s=>this.replaceFromServer(s.items.map(r=>({productId:r.productId,name:r.name,sku:r.sku,price:r.price,qty:r.qty,stock:r.stock}))),error:()=>{this.#t.set(t),this.#i("local")}})}else this.#t.set(t),this.#i("local")}#y(){try{let t=localStorage.getItem(this.#s);if(!t)return[];let e=JSON.parse(t);return Array.isArray(e)?e.filter(s=>s&&typeof s.productId=="string"&&Number.isFinite(s.price)&&Number.isFinite(s.qty)):[]}catch{return[]}}#i(t){try{localStorage.setItem(this.#r,t)}catch{}}#m(t,e){if(this.#t().find(r=>r.productId===t.id))this.#t.update(r=>r.map(i=>{if(i.productId!==t.id)return i;let n=Number.isFinite(i.stock)?i.stock:1/0,m=Math.min(i.qty+e,n);return m===i.qty&&this.#e.warning("Alcanzaste las existencias disponibles"),d(u({},i),{qty:m})}));else{let r=Math.min(e,Number.isFinite(t.stock)?t.stock:e);this.#t.update(i=>[...i,{productId:t.id,name:`${t.brand} ${t.modelName} ${t.size}`,sku:t.sku,price:t.price,qty:r,stock:t.stock}]),r<e&&this.#e.warning("Se agreg\xF3 el m\xE1ximo disponible")}this.#i("local")}#p(t){this.#t.update(e=>e.filter(s=>s.productId!==t)),this.#i("local")}#b(t,e){this.#t.update(s=>s.map(r=>r.productId===t?d(u({},r),{qty:r.qty+e}):r)),this.#i("local")}#I(t,e){this.#t.update(s=>s.flatMap(r=>{if(r.productId!==t)return[r];let i=r.qty-e;return i>0?[d(u({},r),{qty:i})]:[]})),this.#i("local")}#c(t,e){this.#t.update(s=>s.map(r=>{if(r.productId!==t)return r;let i=Number.isFinite(r.stock)&&r.stock>0?Math.min(e,r.stock):e;return d(u({},r),{qty:i})})),this.#i("local")}#l=new Map;#d(t,e){let s=this.#l.get(t);s&&clearTimeout(s);let r=setTimeout(()=>{this.#n.setQty(t,e).subscribe({next:i=>this.replaceFromServer(i.items.map(n=>({productId:n.productId,name:n.name,sku:n.sku,price:n.price,qty:n.qty,stock:n.stock}))),error:()=>this.#e.warning("No se pudo actualizar la cantidad")})},250);this.#l.set(t,r)}applyCoupon(t){let e=(t||"").trim();if(!e){this.#e.info("Ingresa un c\xF3digo v\xE1lido");return}this.#g.validate(e).subscribe({next:s=>{this.#a.set(s),this.#e.success("Cup\xF3n aplicado")},error:()=>{this.#e.danger("Cup\xF3n inv\xE1lido o expirado")}})}clearCoupon(){this.#a.set(null),this.#e.info("Cup\xF3n removido")}#v(){try{let t=localStorage.getItem(this.#u);return t?JSON.parse(t):null}catch{return null}}#h(t){this.#o.isAuthenticated()?this.#n.add(t.productId,t.qty).subscribe({next:e=>this.replaceFromServer(e.items.map(s=>({productId:s.productId,name:s.name,sku:s.sku,price:s.price,qty:s.qty}))),error:()=>this.#f(t)}):this.#f(t)}#f(t){this.#t.update(e=>[...e,t]),this.#i("local")}static \u0275fac=function(e){return new(e||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};export{g as a,y as b,w as c};
